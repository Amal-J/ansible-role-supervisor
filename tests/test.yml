---
- hosts: all

  vars:
    supervisor_user: root
    supervisor_password: fizzbuzz
    supervisor_programs:
      - name: 'apache'
        command: apache2ctl -DFOREGROUND
        state: present
        configuration: |
          autostart=true
          autorestart=true
          startretries=1
          startsecs=1
          redirect_stderr=true
          stderr_logfile=/var/log/apache-err.log
          stdout_logfile=/var/log/apache-out.log
          user=root
          killasgroup=true
          stopasgroup=true

  pre_tasks:
    - name: Update apt cache.
      apt: update_cache=yes cache_valid_time=600
      when: ansible_os_family == 'Debian'

    - name: Install required dependencies.
      yum: name=initscripts state=present
      when: ansible_os_family == 'RedHat' and ansible_distribution_version.split('.')[0] == '6'

    # Install curl for test purposes.
    - package: name=curl state=present

    # Install Apache for test purposes.
    - block:
        - package: name=httpd state=present
        - service: name=httpd state=stopped enabled=no
      when: ansible_os_family == 'RedHat'

    - block:
        - package: name=apache2 state=present
        - service: name=apache2 state=stopped enabled=no
      when: ansible_os_family == 'Debian'

  roles:
    - geerlingguy.pip
    - role_under_test

  tasks:
    - name: Trigger handlers so supervisor runs everything it should run.
      meta: flush_handlers

    - name: Wait for Apache to come up (if it's going to do so...).
      wait_for:
        port: 80
        delay: 2

    - name: Verify Apache is responding on port 80.
      uri:
        url: http://127.0.0.1/
        method: GET
        status_code: 200

    - name: Validate supervisorctl works through the default UNIX socket.
      supervisorctl:
        name: apache
        state: restarted
        username: "{{ supervisor_user }}"
        password: "{{ supervisor_password }}"
      changed_when: false
